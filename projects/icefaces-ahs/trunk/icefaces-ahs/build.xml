<?xml version="1.0"?>

<project name="icefaces-ahs" default="build.src.bundle">
    
    <property file="build.properties"/>
    
    <property name="src.dir" location="src"/>
    <property name="web.dir" location="web"/>
    <property name="lib.dir" location="lib"/>
    <property name="docs.dir" location="docs"/>
    <property name="dist.dir" location="dist"/>
    <property name="bin.dir" location="bin"/>
    
    <property name="build.dir" location="build"/>
    <property name="build.lib.dir" location="${build.dir}/lib"/>
    <property name="build.classes.dir" location="${build.dir}/classes"/>
    <property name="compile.debug" value="true"/>
    
    <property name="product.version" value="${version.primary}.${version.secondary}.${version.tertiary}${release.type}"/>
    <property name="src.bundle.name" value="${product}-${product.version}"/>
    <property name="src.bundle.file" location="${dist.dir}/${src.bundle.name}.zip"/>
    
    <path id="compile.run.classpath">
        <pathelement location="${build.classes.dir}"/>

        <fileset dir="${lib.dir}" includes="**/*.jar"/>
        <fileset dir="${icefaces.lib.dir}" includes="**/*.jar"/>
        <pathelement location="${icefaces.jar}" />
    </path>
    
    <target name="compile">
        <!--echo message="${icefaces.dir}"/-->
        <delete dir="${build.classes.dir}"/>
        <mkdir dir="${build.classes.dir}"/>
        <javac source="1.4" target="1.4" srcdir="${src.dir}" destdir="${build.classes.dir}" debug="${compile.debug}">
            <classpath refid="compile.run.classpath"/>
        </javac>
        <copy todir="${build.classes.dir}">
            <fileset dir="${src.dir}" includes="**/*.dtd"/>
        </copy>
    </target>    
    
    <target name="jar" depends="compile">

        <jar destfile="${lib.dir}/${ant.project.name}.jar" basedir="${build.classes.dir}" duplicate="preserve">
            <manifest>
                <section name="com.icesoft.faces">
                    <attribute name="Implementation-Title" value="${product}"/>
                    <attribute name="Implementation-Version" value="${release.type} ${version.primary}.${version.secondary}.${version.tertiary}_${build.number} (${buildtime})"/>
                    <attribute name="Implementation-Vendor" value="${company}"/>
                </section>
            </manifest>
            <fileset dir="${src.dir}">
                <include name="**/*.properties"/>
            </fileset>
        </jar>
    </target>    
    
    <target name="clean">
        <delete dir="${build.dir}"/>
        <delete dir="${dist.dir}"/>
    </target>
    
    <target name="build.war" depends="clean, jar">
            <mkdir dir="${dist.dir}"/>
        <war destfile="${dist.dir}/async-http-server.war" basedir="web" excludes="WEB-INF/web*.xml" webxml="web/WEB-INF/web.xml" duplicate="fail">
            <lib dir="${icefaces.lib.dir}">
                <include name="commons-beanutils.jar" />
                <include name="commons-collections.jar" />
                <include name="commons-digester.jar" />
                <include name="commons-logging.jar" />
                <include name="commons-discovery.jar" />
                <include name="commons-fileupload-1.0.jar" />
                <include name="commons-el.jar" />
                <include name="icefaces.jar" />
                <include name="jsf-api.jar" />
                <include name="jsf-impl.jar" />
                <include name="xercesImpl.jar" />
                <include name="xml-apis.jar" />
                <include name="jstl.jar" />
                <include name="backport-util-concurrent.jar"/>
            </lib>

            <lib file="${lib.dir}/${ant.project.name}.jar" />
        </war>
    </target>

    <target name="build.src.bundle" depends="clean, jar, build.war">
        <touch  file="${src.bundle.file}" mkdirs="true"/>
        <delete file="${src.bundle.file}"/>
        
        <zip destfile="${src.bundle.file}">
            <zipfileset dir="." prefix="${src.bundle.name}/${ant.project.name}">
                <!-- include name="**/bin/**"/ -->
                <include name="**/src/**"/>
                <include name="**/lib/**"/>
                <include name="**/web/**"/>
                <include name="**/docs/**"/>
                <!--exclude name="**/lib/*jms.jar"/-->
                <include name="build.*"/>
            </zipfileset>
        </zip>
    </target>
    
</project>
