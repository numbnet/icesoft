<div id="geospy" title="Locate It" class="panel" onfocus="geoSpyVisible();">
    <h2>GeoSpy Location Tracking</h2>
    <fieldset>
        <div class="row"><p class="normalText">Continual geolocation tracking with a simple line of JavaScript...</p></div>
        <div class="row">
            <code>
                bridgeit.geoSpy(id, callback,<br/>
                &nbsp;&nbsp;{postURL:myURL});
            </code>
        </div>
    </fieldset>
    
    <a id="track" type="button" class="whiteButton bridgeItBtn"
        onclick="bridgeit.geoSpy('tracker','handleSpy', {postURL: window.serviceHub + '/geospy', parameters: {strategy:'significant',duration:1,_jguid:jguid}});">Start Tracking</a>

        
    <div id="spyMapCanvas" style="height:200px"></div>
    
    <div class="footer">
        <a href="#">
            <img src="./images/icesoft-emblem.png" class="icesoft-emblem"/>
        </a>
        &copy; 2013 ICEsoft Technologies
    </div>
    <script type="text/javascript">
    window.geoSpying = false;
    
    var geospyPushId = ice.push.createPushId();
    ice.push.addGroupMember("geospy", geospyPushId);
    ice.push.register([geospyPushId], function(pushIds) {
        console.log("geospy Push received");
        updateMarkers();
    });

    function handleSpy()  {
    }
    function geoSpyVisible()  {
        initSpyMap();
        setTimeout( function(){
            google.maps.event.trigger(geoSpyMap, 'resize');
            updateMarkers();
        },1000);
    }
    var geoSpyMap;
    var geoSpyMapMarkers = [];
    function initSpyMap() {
        if( !window.geoSpying ){
            window.geoSpying = true;
            var mapOptions = {
                center: new google.maps.LatLng(-34.397, 150.644),
                maxZoom: 16,
                zoom: 8,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            geoSpyMap = new google.maps.Map(document
                    .getElementById('spyMapCanvas'), mapOptions);
            
        }
    }

    function updateMarkers()  {
        ajaxGet(window.serviceHub + '/geospymarkers/' + jguid, processMarkers);
    }

    function processMarkers(data)  {
        if (data){
            var markerData = JSON.parse(data);
            var len = markerData.length;
            var bounds = new google.maps.LatLngBounds();
            var markersPlaced = false;
            for (var i = 0; i < len; i++) {
                //google maps follows english usage LatLang
                //rather than standard x,y coordinate longitude,latitude
                console.log("Map marker " + markerData[i]);
                var coordinates = markerData[i].geometry.coordinates;
                var location = new google.maps.LatLng(
                        coordinates[1], coordinates[0]);
                var markerColor = "#" + 
                        markerData[i].properties.jguid.substring(0,6);

                //check if provided marker is too close to existing marker
                var existLen = geoSpyMapMarkers.length;
                var minDistance = 100;
                for (var j = 0; j < existLen; j++)  {
                    var distance = google.maps.geometry.spherical
                            .computeDistanceBetween (location, 
                            geoSpyMapMarkers[j].position);
                    if (distance < minDistance)  {
                        minDistance = distance;
                    }
                }
                if (minDistance < 50)  {
console.log("too close " + location)
                    break;
                }
console.log("new location, extending bounds " + location)

                markersPlaced = true;
                bounds.extend(location);
                var marker = new google.maps.Marker({
                    position: location,
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        strokeColor: markerColor,
                        scale: 3
                    },
                    map: geoSpyMap
                });
                geoSpyMapMarkers.push(marker);
            }
            if (markersPlaced)  {
                geoSpyMap.fitBounds(bounds);
            }
            
        }
        else{
            console.log('no data for geospy...')
        }
    }

    var jguid;
    if (!jguid)  {
        if (localStorage)  {
            jguid = localStorage.getItem("bridgeit.jguid");
        }
        if (!jguid)  {
            jguid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, 
                function(c) {
                    var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
                    return v.toString(16);
                });
            if (localStorage)  {
                localStorage.setItem("bridgeit.jguid", jguid);
            }
        }

    }
    </script>
</div>
