<!DOCTYPE html>
<html>
<head>
   <title>BridgeIt</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
   <meta name='apple-itunes-app' content="app-id=485908934, app-argument=icemobile://c=register&amp;r=./mobile.html&amp;u=./service/upload"/>
   <link rel="icon" type="image/png" href="favicon.png">
   <link rel="apple-touch-icon" href="bridgeit-logo-touch-icon.png" />
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <link href='http://fonts.googleapis.com/css?family=Euphoria+Script' rel='stylesheet' type='text/css'>
   <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
   <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
   <script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
   <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true&libraries=geometry"></script>
   <script type="application/x-javascript" src="bridgeit.js"></script>
   <script type="text/javascript" src="bridgeit-demos.js"></script>
   <link rel="stylesheet" href="../css/main.css"/>
   <link rel="stylesheet" href="../css/icons.css"/>
   <link rel="stylesheet" href="../css/mobile.css" type="text/css" />
</head>
<body>
    <div data-role="page" id="jqmHome">
        <div data-role="header" class="hdr" data-position="fixed">
            <h1>BridgeIt</h1>
        </div><!-- /header -->
    
        <div data-role="content">
            <div class="splash">
                <div class="platforms">
                    <i class="icon-android"></i><i class="icon-apple"></i><i class="icon-windows soon"></i>
                </div>
                <div class="splash-ctr">
                    <img src="../images/bridgeit-splash.png"/>
                </div>
                <p class="intro">
                    <span class="first-line">Meet BridgeIt...</span>
                     <br/>The easiest way to add native features to your web application. 
                     <br/>A simple JavaScript API to access native features.  
                </p>
                <p>
                Go beyond HTML5...
                </p>
            </div>
            <ul data-role="listview" data-inset="true" id="menu">
                <li><a href="camera.html" data-transition="slide"><i class="icon-camera"></i>Camera</a></li>
                <li><a href="camcorder.html" data-transition="slide"><i class="icon-facetime-video"></i>Camcorder</a></li>
                <li><a href="scan.html" data-transition="slide"><i class="icon-qrcode"></i>Scan</a></li>
                <li><a href="microphone.html" data-transition="slide"><i class="icon-microphone"></i>Microphone</a></li>
                <li><a href="contact-list.html" data-transition="slide"><i class="icon-calendar-empty"></i><i style="font-style:normal;position:absolute;margin-left: -28px;font-size: 10px;margin-top: 7px;">@</i></i>Contact List</a></li>
                <li><a href="geospy.html" data-transition="slide"><i class="icon-location-arrow"></i>GeoSpy</a></li>
                <li><a href="augmented-reality.html" data-transition="slide"><i class="icon-compass"></i>Augmented Reality</a></li>
                <li><a href="sms.html" data-transition="slide"><i class="icon-comment"></i>SMS</a></li>
                <li><a href="cloud-push.html" data-transition="slide"><i class="icon-cloud-download"></i>Cloud Push</a></li>
                <li><a href="docs.html" data-transition="slide"><i class="icon-book"></i>Documentation</a></li>
                <li><a href="about.html" data-transition="slide"><i class="icon-info-sign"></i>About</a></li>
            </ul>
        </div><!-- /content -->
        <div data-role="footer" class="footer">
            <img src="../images/icesoft-emblem.png" class="icesoft-emblem"/>
            &copy; 2013 ICEsoft Technologies
        </div>
    </div><!-- /page -->
    
    <div data-role="page" id="geospy">
        <div data-role="header" data-position="fixed" class="hdr">
            <a data-rel="back" class="btnBack"><i class="icon-angle-left"></i></a>
            <h1>Locate It</h1>
        </div><!-- /header -->
        <div data-role="content">
            <div id="geospy" title="Locate It" class="panel" onfocus="geoSpyVisible();">
                <h2>GeoSpy Location Tracking</h2>
                <fieldset>
                    <div class="row"><p class="normalText">Continual geolocation tracking with a simple line of JavaScript...</p></div>
                    <div class="row">
                        <code>
                            bridgeit.geoSpy(id, callback,<br/>
                            &nbsp;&nbsp;{postURL:myURL});
                        </code>
                    </div>
                </fieldset>
                
                <!--expected final, privacy-preserving variant below-->
                <!--a id="track" type="button" class="whiteButton bridgeItBtn"
                    onclick="bridgeit.geoSpy('tracker','handleSpy', {postURL: window.serviceHub + '/echoput/geospy'+jguid, parameters: {strategy:'significant',duration:1,_jguid:jguid}});">Start Tracking</a-->
                <a id="track" type="button" class="whiteButton bridgeItBtn"
                    onclick="bridgeit.geoSpy('tracker','handleSpy', {postURL: window.serviceHub + '/echoput/geospy', parameters: {strategy:'significant',duration:1,_jguid:jguid}});">Start Tracking</a>
            
                    
                <div id="spyMapCanvas" style="height:200px"></div>
                
                <div class="footer">
                    <a href="#">
                        <img src="../images/icesoft-emblem.png" class="icesoft-emblem"/>
                    </a>
                    &copy; 2013 ICEsoft Technologies
                </div>
                <script type="text/javascript">
                window.geoSpying = false;
                
                bridgeit.usePushService("http://labs.icesoft.com/push");
                bridgeit.addPushListener('geospy', function() {
                    console.log("geospy Push received");
                    updateMarkers();
                });
            
                function handleSpy()  {
                }
                function geoSpyVisible()  {
                    initSpyMap();
                    setTimeout( function(){
                        google.maps.event.trigger(geoSpyMap, 'resize');
                        updateMarkers();
                    },1000);
                }
                var geoSpyMap;
                var geoSpyMapMarkers = [];
                function initSpyMap() {
                    if( !window.geoSpying ){
                        window.geoSpying = true;
                        var mapOptions = {
                            center: new google.maps.LatLng(-34.397, 150.644),
                            maxZoom: 20,
                            zoom: 8,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                        geoSpyMap = new google.maps.Map(document
                                .getElementById('spyMapCanvas'), mapOptions);
                        
                    }
                }
            
                function updateMarkers()  {
            //        ajaxGet(window.serviceHub + '/echofetch/geospy-' + jguid, processMarkers);
                    ajaxGet(window.serviceHub + '/echofetch/geospy', processMarkers);
                }
            
                function processMarkers(data)  {
                    if (data){
                        var markerData = JSON.parse(data);
                        var len = markerData.length;
                        var markersPlaced = false;
                        for (var i = 0; i < len; i++) {
                            //google maps follows english usage LatLang
                            //rather than standard x,y coordinate longitude,latitude
                            var coordinates = markerData[i].geometry.coordinates;
                            var location = new google.maps.LatLng(
                                    coordinates[1], coordinates[0]);
                            var markerColor = "#" + 
                                    markerData[i].properties.jguid.substring(0,6);
            
                            //check if provided marker is too close to existing marker
                            var existLen = geoSpyMapMarkers.length;
                            var minDistance = 100;
                            for (var j = 0; j < existLen; j++)  {
                                var distance = google.maps.geometry.spherical
                                        .computeDistanceBetween (location, 
                                        geoSpyMapMarkers[j].position);
                                if (distance < minDistance)  {
                                    minDistance = distance;
                                }
                            }
                            if (minDistance < 5)  {
                                continue;
                            }
            
                            markersPlaced = true;
                            var marker = new google.maps.Marker({
                                position: location,
                                icon: {
                                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                    strokeColor: markerColor,
                                    scale: 3
                                },
                                map: geoSpyMap
                            });
                            geoSpyMapMarkers.push(marker);
                        }
                        if (markersPlaced)  {
                            var bounds = new google.maps.LatLngBounds();
                            var existLen = geoSpyMapMarkers.length;
                            for (var j = 0; j < existLen; j++)  {
                                bounds.extend(geoSpyMapMarkers[j].position);
                            }
                            geoSpyMap.fitBounds(bounds);
                        }
                        
                    }
                    else{
                        console.log('no data for geospy...')
                    }
                }
            
                var jguid;
                if (!jguid)  {
                    if (localStorage)  {
                        jguid = localStorage.getItem("bridgeit.jguid");
                    }
                    if (!jguid)  {
                        jguid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, 
                            function(c) {
                                var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
                                return v.toString(16);
                            });
                        if (localStorage)  {
                            localStorage.setItem("bridgeit.jguid", jguid);
                        }
                    }
            
                }
                </script>
            </div>
        </div>
    </div>

    <div data-role="page" id="cloudpush">
        <div data-role="header" data-position="fixed" class="hdr">
            <a data-rel="back" class="btnBack"><i class="icon-angle-left"></i></a>
            <h1>Notify It</h1>
        </div><!-- /header -->
        <div data-role="content">
            <div id="cloudpush" title="Notify It" class="panel">
                <h2>Device Notifications</h2>
                <fieldset>
                    <div class="row"><p class="normalText">Cloud notifications with ICEpush...</p></div>
                    <div class="row">
                        <code>
                            ice.push.notify(group,<br/>
                            &nbsp;&nbsp;{subject:'subject', detail:'detail'});
                        </code>
                    </div>
                </fieldset>
            
                <a id="regBtn" type="button" class="whiteButton bridgeItBtn"
                    onclick="bridgeit.register('_reg');">Enable Cloud Push</a>
            
                <a id="pushBtn" type="button" class="whiteButton bridgeItBtn"
                    onclick="delayedPush();">Push in 10 seconds ...</a>
            
                <fieldset>
                    <div class="row"></div>
                </fieldset>
                <fieldset id="notifications">
                </fieldset>
                <div class="footer">
                    <a href="#">
                        <img src="../images/icesoft-emblem.png" class="icesoft-emblem"/>
                    </a>
                    &copy; 2013 ICEsoft Technologies
                </div>
                <script type="text/javascript">
            
                function handleNotification(event)  {
                    alert(event);
                }
            
                bridgeit.usePushService("http://labs.icesoft.com/push");
                //change to a uniquely generated pushID once initial testing is complete
                bridgeit.addPushListener('bridgeit', function() {
                    console.log("notified");
                    alert("You have been notified.");
                });
            
                window.addEventListener("pageShow", function () {
                    ice.push.connection.resumeConnection();
                }, false);
            
                window.addEventListener("pagehide", function () {
                    ice.push.connection.pauseConnection();
                }, false);
            
                function delayedPush()  {
                    bridgeit.push( 'bridgeit',
                        {subject:'BridgeIt Cloud Push',
                        detail:'You have been notified.', delay:10000} );
                }
                </script>
            </div>
        </div>
    </div>
    
 </body>
</html>

