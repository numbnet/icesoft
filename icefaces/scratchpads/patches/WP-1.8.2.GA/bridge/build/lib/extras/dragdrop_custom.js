var DropRegions={init:false,SCALE:10,map:[],register:function(A){var B=A.element;var J=Position.cumulativeOffset(B);var C=[J[0]+B.offsetWidth,J[1]+B.offsetHeight];var H=Math.round(J[0]/this.SCALE);var G=Math.round(J[1]/this.SCALE);var I=Math.round(C[0]/this.SCALE)+1;var F=Math.round(C[1]/this.SCALE)+1;var E=0;var D=0;for(E=H;E<I;E++){for(D=G;D<F;D++){if(this.map[E]==null){this.map[E]=[];}if(this.map[E][D]==null){this.map[E][D]=[];}this.map[E][D].push(A);}}},drops:function(B){var A=Math.round(B[0]/DropRegions.SCALE);var C=Math.round(B[1]/DropRegions.SCALE);if(this.map[A]==null){return[];}if(this.map[A][C]==null){return[];}return this.map[A][C];}};Ice.DndEvent=Class.create();Ice.DndEvent.lastEvent=null;Ice.DndEvent.prototype={drag:null,drop:null,eventType:null,dragFire:null,dropFire:null,submitInfo:new Ice.delimitedProperties(),initialize:function(){},submit:function(){var J=this.drag.element;var F=document.getElementById("iceModalFrame"+J.id);if(F){J.style.zIndex=parseInt(F.style.zIndex)+2;}if(this.drag.options.sort==true){return ;}thisEv=J.id+"-"+this.eventType;try{Ice.DndEvent.lastEvent=thisEv;ignoreDrag=this.ignoreEvent(this.drag.options.mask);if(ignoreDrag){Ice.DnD.logger.debug("Drag Type ["+this.eventType+"] Ignored. Mask ["+this.drag.options.mask+"]");}ignoreDrop=true;if(this.drop){ignoreDrop=this.ignoreEvent(this.drop.mask);}if(this.drop){Ice.DnD.logger.debug("Drop Mask ["+this.drop.mask+"] Ignored ["+ignoreDrop+"]");}if(ignoreDrag&&ignoreDrop){return ;}if(this.drop&&ignoreDrop){Ice.DnD.logger.debug("Drop Type ["+this.eventType+"] Ignored. Mask ["+this.drop.mask+"]");}var A=false;if(this.drag.options.revert==true){A=true;}if(this.drag.options.dragGhost==true){A=true;}if(this.eventType==4||this.eventType==5||this.eventType==1){A=true;}Ice.DnD.logger.debug("DnD Event ["+this.eventType+"] ignoreCss["+A+"] value ["+Ice.DnD.StyleReader.buildStyle(J)+"]");if(!ignoreDrag){Ice.DnD.logger.debug("Drag CSS");this.populateDrag(J,A);if(this.drag.dragGhost==true){this.populateDrag(this.drag._original,A);}}if(!ignoreDrop){Ice.DnD.logger.debug("Drop CSS");this.populateDrop(this.drop.element,A);}var G=$(J.id+"clientOnly");if((!ignoreDrag||!ignoreDrop)&&!G){Ice.DnD.logger.debug("DnD Event ["+this.eventType+"] Sent");var C=Ice.util.findForm(J);var H=C.id;var D=new Object();var B=Ice.DnD.StyleReader.findCssField(J,C);Ice.DnD.logger.debug("Submitting  drag form ID["+C.id+"] CssUpdate ["+B.value+"]!");this.serializeSubmitInfo(C);try{iceSubmitPartial(C,J,D);}catch(E){Ice.DnD.logger.error("error submitting dnd event",E);}Ice.DnD.logger.debug("drag form ID["+C.id+"] submitted");if(!ignoreDrop){C=Ice.util.findForm(this.drop.element);if(C.id!=H){Ice.DnD.logger.debug("Diff ["+C.id+"]!=["+H+"] Submitting");iceSubmitPartial(C,this.drop.element,D);}}this.resetSubmitInfo(C);}}catch(I){Ice.DnD.logger.error("Could not find form in drag drop",I);}return ;},populateDrag:function(B,A){this.submitInfo.set(B.id+"status",this.eventType);if(this.drop){this.submitInfo.set(B.id+"dropID",this.drop.element.id);}if(!A){Ice.DnD.StyleReader.upload(B);}return true;},populateDrop:function(B,A){this.submitInfo.set(B.id+"status",this.eventType);this.submitInfo.set(B.id+"dropID",this.drag.element.id);if(!A){Ice.DnD.StyleReader.upload(B);}return true;},ignoreEvent:function(B){if(!B){return false;}var A=false;if(B){if(B.indexOf(this.eventType)!=-1){A=true;}}return A;},serializeSubmitInfo:function(B){var C=this.submitInfo.getPropsAsString();var A=this.getHiddenField(B);if(A){A.value=C.substring(0,C.length-1);}},resetSubmitInfo:function(B){this.submitInfo.deleteAll();var A=this.getHiddenField(B);if(A){A.value="";}},getHiddenField:function(C){var B=C.id+":iceDND";var A=document.getElementsByName(B)[0];if(A){return A;}else{Ice.DnD.logger.debug("Data field not found");}return null;}};Ice.SortEvent=Class.create();Ice.SortEvent.prototype={start:function(){Ice.DnD.logger.debug("Starting Sort Event");},end:function(){Ice.DnD.logger.debug("Ending Sort Event");}};