var SortableObserver=Class.create();SortableObserver.prototype={initialize:function(B,A){this.element=$(B);this.observer=A;this.lastValue=Sortable.serialize(this.element);},onStart:function(B,C){this.lastValue=Sortable.serialize(this.element);var A=Sortable.options(this.element);A.lastDrag=C;A.lastDrag=C.element.id;},onEnd:function(){Sortable.unmark();var B=Sortable.serialize(this.element);var A=Sortable.options(this.element);A.serializeValue=B;if(this.lastValue!=B){this.observer(this.element);}}};var Sortable={sortables:{},sortableElements:Array(),kids:null,_findRootElement:function(A){while(A.tagName!="BODY"){if(A.id&&Sortable.sortables[A.id]){return A;}A=A.parentNode;}},options:function(A){A=Sortable._findRootElement($(A));if(!A){return ;}return Sortable.sortables[A.id];},destroy:function(B){var C=Sortable.options(B);if(C){Draggables.removeObserver(C.element);C.droppables.each(function(E){Droppables.remove(E);});C.draggables.invoke("destroy");delete Sortable.sortables[C.element.id];var A=0;var D=Array();for(A=0;A<Sortable.sortableElements.length;A++){if(Sortable.sortableElements[A]&&Sortable.sortableElements[A].id!=C.element.id){D.push(Sortable.sortableElements[A]);}}Sortable.sortableElements=D;}},create:function(F,H,E){F=$(F);if(Ice.DnD.alreadySort(F)){Ice.DnD.logger.debug("Sort ID ["+F.id+"] already created");return ;}var B=new Ice.SortableMonitor(F,H);var D=Object.extend({element:F,tag:"li",dropOnEmpty:false,overlap:"vertical",constraint:"vertical",containment:F,handle:false,only:false,hoverclass:null,ghosting:false,format:null,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(F);var A={revert:true,ghosting:D.ghosting,constraint:D.constraint,handle:D.handle,sort:true};if(D.starteffect){A.starteffect=D.starteffect;}if(D.reverteffect){A.reverteffect=D.reverteffect;}else{if(D.ghosting){A.reverteffect=function(I){I.style.top=0;I.style.left=0;};}}if(D.endeffect){A.endeffect=D.endeffect;}if(D.zindex){A.zindex=D.zindex;}var G={overlap:D.overlap,containment:D.containment,hoverclass:D.hoverclass,onHover:Sortable.onHover,greedy:!D.dropOnEmpty,sort:true};Element.cleanWhitespace(F);D.draggables=[];D.droppables=[];if(D.dropOnEmpty){Droppables.add(F,{containment:D.containment,onHover:Sortable.onEmptyHover,greedy:false,sort:true});D.droppables.push(F);}(D.elements||this.findElements(F,D)||[]).each(function(K,I){var J=D.handles?$(D.handles[I]):(D.handle?$(K).select("."+D.handle)[0]:K);D.draggables.push(new Draggable(K,Object.extend(A,{handle:J})));Droppables.add(K,G);if(D.tree){K.treeNode=F;}D.droppables.push(K);});this.sortables[F.id]=D;this.sortableElements.push(F);B.options=D;Ice.StateMon.add(B);var C=new SortableObserver(F,D.onUpdate);Draggables.addObserver(C);},findElements:function(B,A){if(!B.hasChildNodes()){return null;}var C=[];$A(B.childNodes).each(function(D){if(D.tagName&&D.tagName.toUpperCase()==A.tag.toUpperCase()&&(!A.only||(Element.hasClassName(D,A.only)))){C.push(D);}});return(C.length>0?C.flatten():null);},onHover:function(E,D,A){if(A>0.5){Sortable.mark(D,"before");if(D.previousSibling!=E){var B=E.parentNode;E.style.visibility="hidden";D.parentNode.insertBefore(E,D);if(D.parentNode!=B){Sortable.options(B).onChange(E);}Sortable.options(D.parentNode).onChange(E);}}else{Sortable.mark(D,"after");var C=D.nextSibling||null;if(C!=E){var B=E.parentNode;E.style.visibility="hidden";D.parentNode.insertBefore(E,C);if(D.parentNode!=B){Sortable.options(B).onChange(E);}Sortable.options(D.parentNode).onChange(E);}}},onEmptyHover:function(C,B){if(C.parentNode!=B){var A=C.parentNode;B.appendChild(C);Sortable.options(A).onChange(C);Sortable.options(B).onChange(C);}},unmark:function(){if(Sortable._marker){Element.hide(Sortable._marker);}},mark:function(B,A){var D=Sortable.options(B.parentNode);if(!D){return ;}if(D&&!D.ghosting){return ;}if(!Sortable._marker){Sortable._marker=$("dropmarker")||document.createElement("DIV");Element.hide(Sortable._marker);Element.addClassName(Sortable._marker,"dropmarker");Sortable._marker.style.position="absolute";document.getElementsByTagName("body").item(0).appendChild(Sortable._marker);}var C=Position.cumulativeOffset(B);Sortable._marker.style.left=C[0]+"px";Sortable._marker.style.top=C[1]+"px";if(A=="after"){if(D.overlap=="horizontal"){Sortable._marker.style.left=(C[0]+B.clientWidth)+"px";}else{Sortable._marker.style.top=(C[1]+B.clientHeight)+"px";}}Element.show(Sortable._marker);},serialize:function(C){C=$(C);var B=Sortable.options(C);var A=Object.extend({tag:B.tag,only:B.only,name:C.id,format:B.format||/^[^_]*_(.*)$/},arguments[1]||{});return"first;"+B.lastDrag+";changed;"+$(this.findElements(C,A)||[]).map(function(D){return D.id;}).join(";");}};