var Autocompleter={};Autocompleter.Finder={list:new Array(),add:function(B,A){this.list[B.id]=A;},find:function(A){return this.list[A];}};Autocompleter.Base=function(){};Autocompleter.Base.prototype={baseInitialize:function(D,E,C,A,B){this.element=$(D);this.update=$(E);this.hasFocus=false;this.changed=false;this.active=false;this.index=-1;this.entryCount=0;this.rowClass=A;this.selectedRowClass=B;if(this.setOptions){this.setOptions(C);}else{this.options=C||{};}this.options.paramName=this.options.paramName||this.element.name;this.options.tokens=this.options.tokens||[];this.options.frequency=this.options.frequency||0.4;this.options.minChars=this.options.minChars||1;this.options.onShow=this.options.onShow||function(F,G){if(!G.style.position||G.style.position=="absolute"){G.style.position="absolute";Position.clone(F,G,{setHeight:false,offsetTop:F.offsetHeight});G.clonePosition(F.parentNode,{setTop:false,setWidth:false,setHeight:false,offsetLeft:F.offsetLeft-F.parentNode.offsetLeft});}Effect.Appear(G,{duration:0.15});};this.options.onHide=this.options.onHide||function(F,G){new Effect.Fade(G,{duration:0.15});};if(typeof (this.options.tokens)=="string"){this.options.tokens=new Array(this.options.tokens);}this.observer=null;this.element.setAttribute("autocomplete","off");Element.hide(this.update);Event.observe(this.element,"blur",this.onBlur.bindAsEventListener(this));Event.observe(this.element,"keypress",this.onKeyPress.bindAsEventListener(this));if(Prototype.Browser.IE||Prototype.Browser.WebKit){Event.observe(this.element,"keydown",this.onKeyDown.bindAsEventListener(this));}if(Prototype.Browser.IE||Prototype.Browser.WebKit){Event.observe(this.element,"paste",this.onPaste.bindAsEventListener(this));}},show:function(){if(Element.getStyle(this.update,"display")=="none"){this.options.onShow(this.element,this.update);}if(!this.iefix&&(navigator.appVersion.indexOf("MSIE")>0)&&(navigator.userAgent.indexOf("Opera")<0)&&(Element.getStyle(this.update,"position")=="absolute")){var A=Ice.ElementModel.Element.adaptToElement(this.element).findConnection().sendURI;var B=A.substring(0,A.indexOf("block/send-receive-updates"));new Insertion.After(this.update,'<iframe id="'+this.update.id+'_iefix" title="IE6_Fix" style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" src="'+B+'xmlhttp/blank" frameborder="0" scrolling="no"></iframe>');this.iefix=$(this.update.id+"_iefix");}if(this.iefix){setTimeout(this.fixIEOverlapping.bind(this),50);}this.element.focus();},fixIEOverlapping:function(){Position.clone(this.update,this.iefix);this.iefix.style.zIndex=1;this.update.style.zIndex=2;Element.show(this.iefix);},hide:function(){this.stopIndicator();if(Element.getStyle(this.update,"display")!="none"){this.options.onHide(this.element,this.update);}if(this.iefix){Element.hide(this.iefix);}},startIndicator:function(){if(this.options.indicator){Element.show(this.options.indicator);}},stopIndicator:function(){if(this.options.indicator){Element.hide(this.options.indicator);}},onKeyPress:function(B){if(!this.active){Ice.Autocompleter.logger.debug("Key press ignored. Not active.");switch(B.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.getUpdatedChoices(true,B,-1);return ;case Event.KEY_DOWN:this.getUpdatedChoices(false,B,-1);return ;}}Ice.Autocompleter.logger.debug("Key Press");if(this.active){switch(B.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.hidden=true;var A=this.selectEntry();Ice.Autocompleter.logger.debug("Getting updated choices on enter");this.getUpdatedChoices(true,B,A);this.hide();Event.stop(B);return ;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(B);return ;case Event.KEY_LEFT:case Event.KEY_RIGHT:return ;case Event.KEY_UP:if(!(Prototype.Browser.IE||Prototype.Browser.WebKit)){this.markPrevious();this.render();Event.stop(B);return ;}case Event.KEY_DOWN:if(!(Prototype.Browser.IE||Prototype.Browser.WebKit)){this.markNext();this.render();Event.stop(B);return ;}}}else{if(B.keyCode==Event.KEY_TAB||B.keyCode==Event.KEY_RETURN){return ;}}this.changed=true;this.hasFocus=true;this.index=-1;this.skip_mouse_hover=true;if(this.active){this.render();}if(this.observer){clearTimeout(this.observer);}this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000);},onKeyDown:function(A){if(!this.active){switch(A.keyCode){case Event.KEY_DOWN:this.getUpdatedChoices(false,A,-1);return ;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:if(this.observer){clearTimeout(this.observer);}this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000);return ;}}else{if(this.active){switch(A.keyCode){case Event.KEY_UP:this.markPrevious();this.render();Event.stop(A);return ;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(A);return ;case Event.KEY_ESC:if(Prototype.Browser.WebKit){this.hide();this.active=false;Event.stop(A);return ;}case Event.KEY_BACKSPACE:case Event.KEY_DELETE:if(this.observer){clearTimeout(this.observer);}this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000);return ;}}}},activate:function(){this.changed=false;this.hasFocus=true;},onHover:function(B){var A=Event.findElement(B,"DIV");if(this.index!=A.autocompleteIndex){if(!this.skip_mouse_hover){this.index=A.autocompleteIndex;}this.render();}Event.stop(B);},onMove:function(A){if(this.skip_mouse_hover){this.skip_mouse_hover=false;this.onHover(A);}},onClick:function(C){this.hidden=true;var B=Event.findElement(C,"DIV");this.index=B.autocompleteIndex;var A=B.autocompleteIndex;this.selectEntry();this.getUpdatedChoices(true,C,A);this.hide();},onBlur:function(C){if(navigator.userAgent.indexOf("MSIE")>=0){var B=document.compatMode&&document.compatMode=="CSS1Compat";var A=B?document.documentElement:document.body;if(C.clientX>A.clientLeft+A.clientWidth||C.clientY>A.clientTop+A.clientHeight){this.element.focus();return ;}}setTimeout(this.hide.bind(this),250);this.hasFocus=false;this.active=false;},onPaste:function(A){this.changed=true;this.hasFocus=true;this.index=-1;this.skip_mouse_hover=true;if(this.active){this.render();}if(this.observer){clearTimeout(this.observer);}this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000);return ;},render:function(){if(this.entryCount>0){for(var B=0;B<this.entryCount;B++){if(this.index==B){ar=this.rowClass.split(" ");for(var A=0;A<ar.length;A++){Element.removeClassName(this.getEntry(B),ar[A]);}ar=this.selectedRowClass.split(" ");for(var A=0;A<ar.length;A++){Element.addClassName(this.getEntry(B),ar[A]);}}else{ar=this.selectedRowClass.split(" ");for(var A=0;A<ar.length;A++){Element.removeClassName(this.getEntry(B),ar[A]);}ar=this.rowClass.split(" ");for(var A=0;A<ar.length;A++){Element.addClassName(this.getEntry(B),ar[A]);}}}if(this.hasFocus){this.show();this.active=true;}}else{this.active=false;this.hide();}},markPrevious:function(){if(this.index>0){this.index--;}else{this.index=this.entryCount-1;}},markNext:function(){if(this.index==-1){this.index++;return ;}if(this.index<this.entryCount-1){this.index++;}else{this.index=0;}},getEntry:function(B){try{return this.update.firstChild.childNodes[B];}catch(A){return null;}},getCurrentEntry:function(){return this.getEntry(this.index);},selectEntry:function(){var A=-1;this.active=false;if(this.index>=0){A=this.index;this.updateElement(this.getCurrentEntry());this.index=-1;}return A;},updateElement:function(F){if(this.options.updateElement){this.options.updateElement(F);return ;}var C="";if(this.options.select){var A=document.getElementsByClassName(this.options.select,F)||[];if(A.length>0){C=Element.collectTextNodes(A[0],this.options.select);}}else{C=Element.collectTextNodesIgnoreClass(F,"informal");}var E=this.findLastToken();if(E!=-1){var D=this.element.value.substr(0,E+1);var B=this.element.value.substr(E+1).match(/^\s+/);if(B){D+=B[0];}this.element.value=D+C;}else{this.element.value=C;}this.element.focus();if(this.options.afterUpdateElement){this.options.afterUpdateElement(this.element,F);}},updateChoices:function(C){if(!this.changed&&this.hasFocus){this.update.innerHTML=C;Element.cleanWhitespace(this.update);Element.cleanWhitespace(this.update.firstChild);if(this.update.firstChild&&this.update.firstChild.childNodes){this.entryCount=this.update.firstChild.childNodes.length;for(var A=0;A<this.entryCount;A++){var B=this.getEntry(A);B.autocompleteIndex=A;this.addObservers(B);}}else{this.entryCount=0;}this.stopIndicator();this.index=-1;this.render();}else{Ice.Autocompleter.logger.debug("Not updating choices Not Changed["+this.changed+"] hasFocus["+this.hasFocus+"]");}},addObservers:function(A){Event.observe(A,"mouseover",this.onHover.bindAsEventListener(this));Event.observe(A,"click",this.onClick.bindAsEventListener(this));Event.observe(A,"mousemove",this.onMove.bindAsEventListener(this));},dispose:function(){for(var A=0;A<this.entryCount;A++){var B=this.getEntry(A);B.autocompleteIndex=A;Event.stopObserving(B,"mouseover",this.onHover);Event.stopObserving(B,"click",this.onClick);Event.stopObserving(B,"mousemove",this.onMove);}Event.stopObserving(this.element,"mouseover",this.onHover);Event.stopObserving(this.element,"click",this.onClick);Event.stopObserving(this.element,"mousemove",this.onMove);Event.stopObserving(this.element,"blur",this.onBlur);Event.stopObserving(this.element,"keypress",this.onKeyPress);if(Prototype.Browser.IE||Prototype.Browser.WebKit){Event.stopObserving(this.element,"keydown",this.onKeyDown);}Autocompleter.Finder.list[this.element.id]=null;Ice.Autocompleter.logger.debug("Destroyed autocomplete ["+this.element.id+"]");},onObserverEvent:function(){this.changed=false;if(this.getToken().length>=this.options.minChars){this.startIndicator();this.getUpdatedChoices(false,undefined,-1);}else{this.active=false;this.hide();this.getUpdatedChoices(false,undefined,-1);}},getToken:function(){var B=this.findLastToken();if(B!=-1){var A=this.element.value.substr(B+1).replace(/^\s+/,"").replace(/\s+$/,"");}else{var A=this.element.value;}return/\n/.test(A)?"":A;},findLastToken:function(){var C=-1;for(var B=0;B<this.options.tokens.length;B++){var A=this.element.value.lastIndexOf(this.options.tokens[B]);if(A>C){C=A;}}return C;}};Ajax.Autocompleter=Class.create();Object.extend(Object.extend(Ajax.Autocompleter.prototype,Autocompleter.Base.prototype),{initialize:function(C,D,B,A){this.baseInitialize(C,D,A);this.options.asynchronous=true;this.options.onComplete=this.onComplete.bind(this);this.options.defaultParams=this.options.parameters||null;this.url=B;},getUpdatedChoices:function(){entry=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,entry):entry;if(this.options.defaultParams){this.options.parameters+="&"+this.options.defaultParams;}new Ajax.Request(this.url,this.options);},onComplete:function(A){this.updateChoices(A.responseText);}});Ice.Autocompleter=Class.create();Object.extend(Object.extend(Ice.Autocompleter.prototype,Autocompleter.Base.prototype),{initialize:function(H,F,C,B,E){Ice.Autocompleter.logger.debug("Building Ice Autocompleter ID ["+H+"]");var G=Autocompleter.Finder.list[H];if(G&&!G.monitor.changeDetected()){return ;}if(C){C.minChars=0;}else{C={minChars:0};}var D=$(H);var A=$(F);this.baseInitialize(D,A,C,B,E);this.options.onComplete=this.onComplete.bind(this);this.options.defaultParams=this.options.parameters||null;this.monitor=new Ice.AutocompleterMonitor(D,A,C,B,E);this.monitor.object=this;Ice.StateMon.add(this.monitor);Autocompleter.Finder.add(this.element,this);Ice.Autocompleter.logger.debug("Done building Ice Autocompleter");if(this.monitor.changeDetected()){Ice.Autocompleter.logger.debug("Change has been detected");}},getUpdatedChoices:function(B,D,A){if(!D){D=new Object();}entry=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,entry):entry;if(this.options.defaultParams){this.options.parameters+="&"+this.options.defaultParams;}var C=Ice.util.findForm(this.element);if(A>-1){var E=this.element.id+"_idx";C[E].value=A;}if(B){Ice.Autocompleter.logger.debug("Sending submit");iceSubmit(C,this.element,D);}else{Ice.Autocompleter.logger.debug("Sending partial submit");iceSubmitPartial(C,this.element,D);}},onComplete:function(A){this.updateChoices(A.responseText);},updateNOW:function(A){if(this.hidden){this.hidden=false;return ;}this.hasFocus=true;Element.cleanWhitespace(this.update);this.updateChoices(A);this.show();this.render();}});