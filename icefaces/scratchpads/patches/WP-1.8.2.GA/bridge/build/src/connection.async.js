[Ice.Community.Connection=new Object,Ice.Connection,Ice.Ajax,Ice.Reliability.Heartbeat,Ice.Cookie,Ice.Parameter.Query].as(function(F,E,C,D,A,B){F.AsyncConnection=Object.subclass({initialize:function(g,U,Z,V,M,Y){this.logger=g.child("async-connection");this.sendChannel=new C.Client(this.logger.child("ui"));this.receiveChannel=new C.Client(this.logger.child("blocking"));this.defaultQuery=M;this.onSendListeners=[];this.onReceiveFromSendListeners=[];this.onReceiveListeners=[];this.onServerErrorListeners=[];this.connectionDownListeners=[];this.connectionTroubleListeners=[];this.listener={close:Function.NOOP,abort:Function.NOOP};this.listening={remove:Function.NOOP};this.timeoutBomb={cancel:Function.NOOP};this.heartbeat={stop:Function.NOOP};this.pingURI=V.pingURI;this.getURI=V.receiveUpdatesURI;this.sendURI=V.sendReceiveUpdatesURI;this.receiveURI=V.receiveUpdatedViewsURI;window.onBeforeUnload(function(){this.connectionDownListeners.clear();}.bind(this));var Q=V.timeout?V.timeout:60000;this.onSend(function(){this.timeoutBomb.cancel();this.timeoutBomb=this.connectionDownListeners.broadcaster().delayExecutionFor(Q);}.bind(this));this.onReceive(function(){this.timeoutBomb.cancel();}.bind(this));this.serverErrorCallback=this.onServerErrorListeners.broadcaster();this.receiveCallback=function(i){try{this.onReceiveListeners.broadcast(i);}catch(j){this.logger.error("receive broadcast failed",j);}}.bind(this);this.sendXWindowCookie=Function.NOOP;this.receiveXWindowCookie=function(e){var i=e.getResponseHeader("X-Set-Window-Cookie");if(i){this.sendXWindowCookie=function(j){j.setRequestHeader("X-Window-Cookie",i);};}}.bind(this);try{this.updatedViews=A.lookup("updates");}catch(b){this.updatedViews=new A("updates","");}Y.register("updated-views",function(i){var e=this.updatedViews.loadValue().split(" ");var j=i.firstChild;if(j&&!j.data.blank()){this.updatedViews.saveValue(e.concat(j.data.split(" ")).asSet().join(" "));}else{this.logger.warn("No updated views were returned.");}}.bind(this));try{this.listening=A.lookup("bconn");this.listening.remove();}catch(b){}var h=function(k,e,i){var j=0;var l=i.inject([e],function(n,m){n.unshift(k.delayFor(m));return n;});return function(){if(j<l.length){l[j].apply(this,arguments);j++;}};};function a(){return A.lookup("ice.sessions").loadValue().split(" ").collect(function(e){return e.split("#")[0];});}this.connect=function(){this.logger.debug("closing previous connection...");this.listener.close();this.logger.debug("connect...");var e=new B();a().each(function(i){e.add("ice.session",i);});this.listener=this.receiveChannel.postAsynchronously(this.receiveURI,e.asURIEncodedString(),function(i){this.sendXWindowCookie(i);E.FormPost(i);i.on(E.ServerError,K);i.on(E.OK,this.receiveXWindowCookie);i.on(E.OK,function(j){if(!j.isEmpty()){this.receiveCallback(j);}if(j.getResponseHeader("X-Connection")!="close"){this.connect();}else{this.heartbeat.stop();}}.bind(this));i.on(E.OK,E.Close);}.bind(this));}.bind(this);var K=h(this.connect,this.serverErrorCallback,V.serverErrorRetryTimeouts||[1000,2000,4000]);Y.register("pong",Function.NOOP);var H=V.heartbeat.interval?V.heartbeat.interval:50000;var L=V.heartbeat.timeout?V.heartbeat.timeout:30000;var c=V.heartbeat.retries?V.heartbeat.retries:3;var R=function(){this.heartbeat.stop();this.heartbeat=new D(H,L,this.logger);this.heartbeat.onPing(function(e){Y.register("pong",function(){e.pong();});this.sendChannel.postAsynchronously(this.pingURI,this.defaultQuery.asURIEncodedString(),function(i){E.FormPost(i);i.on(E.OK,this.receiveCallback);i.on(E.OK,E.Close);}.bind(this));}.bind(this));this.heartbeat.onLostPongs(this.connectionDownListeners.broadcaster(),c);this.heartbeat.onLostPongs(this.connectionTroubleListeners.broadcaster());this.heartbeat.onLostPongs(function(){this.logger.debug("retry to connect...");this.connect();}.bind(this));this.heartbeat.start();this.connect();}.bind(this);var P=1000;var f=U+":"+Z;var d=A.lookup("ice.lease",(new Date).getTime().toString());var W=this.listening=A.lookup("bconn","-");function J(){d.saveValue((new Date).getTime()+P*2);}function G(){return d.loadValue().asNumber()<(new Date).getTime();}function I(){return !A.exists("bconn")||A.lookup("bconn").value=="-";}function N(){W.saveValue(f);}function S(){return W.loadValue().startsWith(f);}function O(){W.saveValue(f+":acquired");}function X(){return W.loadValue().endsWith(":acquired");}this.blockingConnectionMonitor=function(){try{if(I()){N();this.logger.info("blocking connection not initialized...candidate for its creation");}else{if(S()){if(!X()){O();R();}J();}if(X()&&G()){N();this.logger.info("blocking connection lease expired...candidate for its creation");}}}catch(i){this.logger.info("could not determine the state of the blocking connection...retrying",i);}}.bind(this).repeatExecutionEvery(P);var T=function(){this.sendChannel.postAsynchronously(this.getURI,this.defaultQuery.asURIEncodedString(),function(e){E.FormPost(e);e.on(E.OK,this.receiveCallback);e.on(E.OK,E.Close);}.bind(this));}.bind(this);T.delayExecutionFor(P);this.updatesMonitor=function(){try{var i=this.updatedViews.loadValue().split(" ");if(i.include(f)){T();this.updatedViews.saveValue(i.complement([f]).join(" "));}}catch(j){this.logger.warn("failed to listen for updates",j);}}.bind(this).repeatExecutionEvery(300);this.lock=V.blockUI?new E.Lock():new E.NOOPLock();this.logger.info("asynchronous mode");},send:function(H){if(this.lock.isReleased()){this.lock.acquire();try{var G=new B();G.addQuery(H);G.addQuery(this.defaultQuery);G.add("ice.focus",window.currentFocus);this.logger.debug("send > "+G.asString());this.sendChannel.postAsynchronously(this.sendURI,G.asURIEncodedString(),function(J){E.FormPost(J);J.on(E.OK,this.lock.release);J.on(E.OK,this.onReceiveFromSendListeners.broadcaster());J.on(E.OK,this.receiveCallback);J.on(E.ServerError,this.serverErrorCallback);J.on(E.OK,E.Close);this.onSendListeners.broadcast();}.bind(this));}catch(I){this.lock.release();}}},onSend:function(H,G){this.onSendListeners.push(H);if(G){this.onReceiveFromSendListeners.push(G);}},onReceive:function(G){this.onReceiveListeners.push(G);},onServerError:function(G){this.onServerErrorListeners.push(G);},whenDown:function(G){this.connectionDownListeners.push(G);},whenTrouble:function(G){this.connectionTroubleListeners.push(G);},shutdown:function(){try{this.shutdown=Function.NOOP;this.send=Function.NOOP;this.connect=Function.NOOP;this.heartbeat.stop();}catch(G){}finally{[this.onSendListeners,this.onReceiveListeners,this.connectionDownListeners,this.onServerErrorListeners,this.onReceiveFromSendListeners].eachWithGuard(function(H){H.clear();});this.listener.abort();[this.updatesMonitor,this.blockingConnectionMonitor].eachWithGuard(function(H){H.cancel();});this.listening.remove();}}});});