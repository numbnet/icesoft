[Ice.Reliability=new Object].as(function(A){A.Heartbeat=Object.subclass({initialize:function(D,C,B){this.period=D;this.logger=B.child("heartbeat");this.pingListeners=[];this.lostPongListeners=[];this.beat=function(){var E=function(){this.logger.warn("pong lost");this.lostPongListeners.each(function(F){F.notify();});}.bind(this).delayExecutionFor(C);this.pingListeners.broadcast(new A.Ping(E,this,this.logger));}.bind(this);window.onKeyPress(function(E){if(E.keyCode()==46&&E.isCtrlPressed()&&E.isShiftPressed()){this.beatPID?this.stop():this.start();}}.bind(this));},start:function(){this.beatPID=this.beat.repeatExecutionEvery(this.period);this.logger.info("heartbeat started");return this;},stop:function(){try{this.beatPID.cancel();this.beatPID=null;this.pingListeners.clear();this.lostPongListeners.each(function(C){C.ignoreNotifications();});this.logger.info("heartbeat stopped");}catch(B){this.logger.warn("heartbeat not started",B);}return this;},reset:function(){this.lostPongListeners.each(function(B){B.reset();});},onPing:function(B){this.pingListeners.push(B);},onLostPongs:function(D,C){var B=C||1;this.lostPongListeners.push(new A.CoalescingListener(B,D));}});A.Ping=Object.subclass({initialize:function(B,D,C){this.pid=B;this.heartbeat=D;this.logger=C;this.logger.info("ping");},pong:function(){if(this.pid){this.heartbeat.reset();this.pid.cancel();this.pong=Function.NOOP;this.logger.info("pong");}}});A.CoalescingListener=Object.subclass({initialize:function(B,C){this.count=0;this.retries=B;this.callback=C;},notify:function(){this.count+=1;if(this.count==this.retries){this.callback();this.reset();}},ignoreNotifications:function(){this.notify=Function.NOOP;},reset:function(){this.count=0;}});});