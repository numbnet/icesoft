window.logger=new Ice.Log.Logger(["window"]);window.console&&window.console.firebug?new Ice.Log.FirebugLogHandler(window.logger):new Ice.Log.WindowLogHandler(window.logger,window);[Ice.Community].as(function(D){var E=function(Q){try{var N=Ice.Cookie.lookup("ice.sessions");var R=N.loadValue().split(" ");var M=function(S){return S.startsWith(Q);};var P=R.detect(M);if(P){R=R.reject(M);var L=P.split("#")[1].asNumber()+1;R.push(Q+"#"+L);}else{R.push(Q+"#"+1);}N.saveValue(R.join(" "));}catch(O){new Ice.Cookie("ice.sessions",Q+"#"+1);}};var F=function(M){if(Ice.Cookie.exists("ice.sessions")){var L=Ice.Cookie.lookup("ice.sessions");var N=L.loadValue().split(" ");L.saveValue(N.inject([],function(O,Q){if(Q){var R=Q.split("#");var S=R[0];var P=R[1].asNumber();if(S==M){--P;}if(P>0){O.push(R[0]+"#"+P);}}return O;}).join(" "));}};var K=window.views=window.views?window.views:[];var J=function(M,L){E(M);K.push(new Ice.Parameter.Association(M,L));};var C=function(){K.each(function(L){F(L.name);});K.clear();};var I=new Ice.Ajax.Client(logger.child("dispose"));var B=function(L){if(L.isEmpty()){return ;}try{var M=L.inject(new Ice.Parameter.Query(),function(O,P){return O.addParameter(P);});I.postSynchronously(window.disposeViewsURI,M.asURIEncodedString(),function(O){Ice.Connection.FormPost(O);O.on(Ice.Connection.OK,Ice.Connection.Close);});}catch(N){logger.warn("Failed to notify view disposal",N);}};var G=function(M,L){F(M);K=K.reject(function(N){return N.name==M&&N.value==L;});};var H=function(M,L){G(M,L);B([new Ice.Parameter.Association(M,L)]);};var A=function(){B(K);C();};window.onBeforeUnload(A);D.Application=Object.subclass({initialize:function(P,M){var U=P.session;var Q=P.view;J(U,Q);var X=window.logger.child(U.substring(0,4)+"#"+Q);var T=new Ice.Status.DefaultStatusManager(P,M);var L=new Ice.Script.Loader(X);var Z=new Ice.Command.Dispatcher();var S=new Ice.Document.Synchronizer(window.logger,U,Q);var W=Ice.Parameter.Query.create(function(a){a.add("ice.session",U);a.add("ice.view",Q);});var O=function(a){Ice.Document.replaceContainerHTML(M,a);L.searchAndEvaluateScripts(M);};var N=P.synchronous?new Ice.Connection.SyncConnection(X,P.connection,W):new D.Connection.AsyncConnection(X,U,Q,P.connection,W,Z);var V=function(){V=Function.NOOP;N.shutdown();S.shutdown();};var R=[];var Y=function(a){R.push(a);};Z.register("noop",Function.NOOP);Z.register("set-cookie",Ice.Command.SetCookie);Z.register("parsererror",Ice.Command.ParsingError);Z.register("redirect",function(b){V();var a=b.getAttribute("url").replace(/&#38;/g,"&");X.info("Redirecting to "+a);window.location.href=a;});Z.register("reload",function(d){X.info("Reloading");var c=window.location.href;B=Function.NOOP;V();if(c.contains("rvn=")){window.location.reload();}else{var a=d.getAttribute("view");if(a==""){window.location.reload();}else{var b=c.contains("?")?"&":"?";window.location.href=c+b+"rvn="+a;}}});Z.register("macro",function(a){$enumerate(a.childNodes).each(function(b){Z.deserializeAndExecute(b);});});Z.register("updates",function(a){$enumerate(a.getElementsByTagName("update")).each(function(d){try{var b=d.getAttribute("address");var g=new Ice.ElementModel.Update(d);b.asExtendedElement().updateDOM(g);X.debug("applied update : "+g.asString());var c=b.asElement();Ice.Focus.captureFocusIn(c);L.searchAndEvaluateScripts(c);if(Ice.StateMon){Ice.StateMon.checkAll();Ice.StateMon.rebuild();}}catch(f){X.error("failed to insert element: "+g.asString(),f);}});});Z.register("session-expired",function(){try{X.warn("Session has expired");T.busy.off();T.sessionExpired.on();G(U,Q);}finally{V();R.broadcast();}});window.onUnload(function(){V();});N.onSend(function(){T.busy.on();},function(){T.busy.off();});N.onReceive(function(a){var b=a.getResponseHeader("Content-Type");if(b.startsWith("text/html")){O(a.content());}else{if(b.startsWith("text/xml")){S.synchronize();Z.deserializeAndExecute(a.contentAsDOM().documentElement);}else{X.warn("unknown content in response");}}T.connectionTrouble.off();});N.onServerError(function(a){X.warn("server side error");T.busy.off();H(U,Q);if(a.isEmpty()){T.serverError.on();}else{O(a.content());}V();});N.whenDown(function(){X.warn("connection to server was lost");T.busy.off();T.connectionLost.on();V();});N.whenTrouble(function(){X.warn("connection in trouble");T.connectionTrouble.on();});this.attachStatusManager=function(a){T.off();T=a(new Ice.Status.DefaultStatusManager(P,M));X.info("status indicators were updated");};this.connection=N;this.onSessionExpired=Y;this.dispose=V;this.disposeAndNotify=function(){H(U,Q);V();};X.info("bridge loaded!");}});});window.onKeyPress(function(A){if(A.isEscKey()){A.cancelDefaultAction();}});