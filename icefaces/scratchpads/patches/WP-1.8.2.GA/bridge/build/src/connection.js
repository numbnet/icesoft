[Ice.Connection=new Object,Ice.Connection,Ice.Ajax,Ice.Parameter.Query].as(function(D,C,B,A){D.FormPost=function(E){E.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");};D.Close=function(E){E.close();};D.BadResponse=function(E){return E.statusCode()==0;};D.ServerError=function(E){var F=E.statusCode();return F>=500&&F<600;};D.OK=function(E){return E.statusCode()==200;};D.Lock=Object.subclass({initialize:function(){var E=false;this.acquire=function(){E=true;}.bind(this);this.release=function(){E=false;}.bind(this);this.isReleased=function(){return !E;}.bind(this);}});D.NOOPLock=Object.subclass({initialize:function(){this.acquire=Function.NOOP;this.release=Function.NOOP;this.isReleased=function(){return true;};}});D.SyncConnection=Object.subclass({initialize:function(F,I,E,H){this.logger=F.child("sync-connection");this.channel=new B.Client(this.logger);this.defaultQuery=E;this.onSendListeners=[];this.onReceiveFromSendListeners=[];this.onReceiveListeners=[];this.onServerErrorListeners=[];this.connectionDownListeners=[];this.timeoutBomb={cancel:Function.NOOP};this.logger.info("synchronous mode");this.sendURI=I.sendReceiveUpdatesURI;var G=I.timeout?I.timeout:60000;window.onBeforeUnload(function(){this.connectionDownListeners.clear();}.bind(this));this.onSend(function(){this.timeoutBomb.cancel();this.timeoutBomb=this.connectionDownListeners.broadcaster().delayExecutionFor(G);}.bind(this));this.onReceive(function(){this.timeoutBomb.cancel();}.bind(this));this.whenDown(function(){this.timeoutBomb.cancel();}.bind(this));this.receiveCallback=function(J){try{this.onReceiveListeners.broadcast(J);}catch(K){this.logger.error("receive broadcast failed",K);}}.bind(this);this.badResponseCallback=this.connectionDownListeners.broadcaster();this.serverErrorCallback=this.onServerErrorListeners.broadcaster();this.lock=I.blockUI?new C.Lock():new C.NOOPLock();},send:function(F){if(this.lock.isReleased()){this.lock.acquire();try{var E=new A();E.addQuery(F);E.addQuery(this.defaultQuery);E.add("ice.focus",window.currentFocus);this.logger.debug("send > "+E.asString());this.channel.postAsynchronously(this.sendURI,E.asURIEncodedString(),function(H){D.FormPost(H);H.on(C.OK,this.lock.release);H.on(C.OK,this.onReceiveFromSendListeners.broadcaster());H.on(C.OK,this.receiveCallback);H.on(C.BadResponse,this.badResponseCallback);H.on(C.ServerError,this.serverErrorCallback);H.on(C.OK,C.Close);this.onSendListeners.broadcast(H);}.bind(this));}catch(G){this.lock.release();}}},onSend:function(F,E){this.onSendListeners.push(F);if(E){this.onReceiveFromSendListeners.push(E);}},onReceive:function(E){this.onReceiveListeners.push(E);},onServerError:function(E){this.onServerErrorListeners.push(E);},whenDown:function(E){this.connectionDownListeners.push(E);},whenTrouble:Function.NOOP,shutdown:function(){this.shutdown=Function.NOOP;this.send=Function.NOOP;[this.onSendListeners,this.onReceiveListeners,this.onServerErrorListeners,this.connectionDownListeners,this.onReceiveFromSendListeners].eachWithGuard(function(E){E.clear();});}});});