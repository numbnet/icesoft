<project name="common">

<property name="build.sysclasspath" value="ignore"/>

<property name="build.dir" location="build"/>
<property name="dist.dir" location="dist"/>
<property name="src.dir" location="src"/>
<property name="web.content.dir" location="web"/>
<property name="web.inf.dir" location="${web.content.dir}/WEB-INF"/>
<property name="classes.dir" location="${web.inf.dir}/classes"/>
<property name="app.lib.dir" location="${web.inf.dir}/lib"/>

<property name="compile.source" value="1.4"/>
<property name="compile.target" value="1.4"/>
<property name="compile.debug" value="true"/>

<dirname property="build.common.basedir" file="${ant.file.common}"/>
<property name="icefaces.lib.dir" location="${build.common.basedir}/../../lib"/>

<property name="portlet.base.dir" location="./build"/>
<property name="portlet.web.content.dir" location="${portlet.base.dir}/web"/>
<property name="portlet.web.dir" location="./portlet/web"/>
<property name="portlet.web.inf.dir" location="${portlet.web.content.dir}/WEB-INF"/>
<property name="portlet.app.lib.dir" location="${portlet.web.inf.dir}/lib"/>


<property name="portlet.conf.dir" location="./portlet/conf"/>
<property name="portlet.xml" value="portlet.xml"/>
<property name="portlet.liferay.dir" location="${portlet.conf.dir}/liferay"/>

<patternset id="liferay.xmls">
	<exclude name="liferay-display.xml" unless="liferay"/>
	<exclude name="liferay-plugin-package.xml" unless="liferay"/>
	<exclude name="liferay-portlet.xml" unless="liferay"/>
</patternset>

<patternset id="portlet.jar" includes="portlet.jar"/>
<!--/patternset-->

<patternset id="common.icefaces.lib.jars.to.include"
    includes="
        backport-util-concurrent.jar
        commons-beanutils.jar
        commons-collections.jar
        commons-digester.jar
        commons-discovery.jar
        commons-el.jar
        commons-fileupload.jar
        commons-logging.jar
        icefaces.jar
        icefaces-comps.jar
        el-api.jar
        jstl.jar
        xercesImpl.jar
        xml-apis.jar
    " >
    <exclude name="el-api.jar"     if="jsf12" />
    <exclude name="el-api.jar"     if="serverel" />
    <exclude name="jstl.jar"       if="serverjsf" />
    <exclude name="xercesImpl.jar" if="jsf12" />
    <exclude name="xml-apis.jar"   if="jsf12" />
    <exclude name="icefaces.jar" if="just-ice" />
</patternset>

<patternset id="additional.icefaces.lib.jars.to.include">
	<include name="just-ice.jar" if="just-ice" />
</patternset>

<patternset id="additional.compile.lib.jars"/>

<patternset id="portlet.conf.files">
	<include name="**/*.xml" if="liferay"/>
</patternset>

<patternset id="jsf.compile.jars" >
    <include name="myfaces-api.jar"  if="myfaces" />
    <include name="myfaces-impl.jar" if="myfaces" />
    <include name="commons-lang.jar" if="myfaces"/>
    <include name="jsf-api.jar"  unless="myfaces" />
    <include name="jsf-impl.jar" unless="myfaces" />
</patternset>

<patternset id="jsf.deploy.jars" >
    <include name="myfaces-api.jar"  if="myfaces" />
    <include name="myfaces-impl.jar" if="myfaces" />
    <include name="commons-lang.jar" if="myfaces"/>
    <include name="jsf-api.jar"  unless="myfaces" />
    <include name="jsf-impl.jar" unless="myfaces" />
    <exclude name="jsf-api.jar"      if="jsf12" />
    <exclude name="jsf-impl.jar"     if="jsf12" />
    <include name="jsf-api-1.2.jar"  if="jsf12" />
    <include name="jsf-impl-1.2.jar" if="jsf12" />
    <exclude name="*.jar" if="serverjsf" />
</patternset>

<patternset id="icefaces.lib"
    includes="
        backport-util-concurrent.jar
        commons-beanutils.jar
        commons-collections.jar
        commons-digester.jar
        commons-discovery.jar
        commons-el.jar
        commons-fileupload.jar
        commons-logging.jar
        icefaces.jar
        icefaces-comps.jar
        el-api.jar
        jstl.jar
        xercesImpl.jar
        xml-apis.jar

	myfaces-api.jar
	myfaces-impl.jar
	jsf-api.jar
	jsf-impl.jar
	jsf-api-1.2.jar
	jsf-impl-1.2.jar

	krysalis-jCharts-1.0.0-alpha-1.jar
	servlet-api.jar
	icefaces-facelets.jar
	el-ri.jar

	commons-lang.jar
	commons-lang-2.1.jar
	">
</patternset>

<macrodef name="clean">
    <sequential>
        <delete includeemptydirs="true" quiet="true">
            <fileset dir="${build.dir}"/>
            <fileset dir="${dist.dir}"/>
            <fileset dir="${classes.dir}" includes="**/*"/>
            <fileset dir="${app.lib.dir}">
            	<patternset refid="icefaces.lib"/>
            </fileset>
                <!--patternset refid="common.icefaces.lib.jars.to.include"/>
                <patternset refid="additional.icefaces.lib.jars.to.include"/>
            </fileset>
            <fileset dir="${app.lib.dir}">
                <patternset refid="jsf.deploy.jars" />
            </fileset-->
        </delete>
    </sequential>
</macrodef>

<macrodef name="compile">
    <attribute name="src.copy.excludes" default=""/>
    <attribute name="failonerror" default="true"/>
    <attribute name="src.javac.excludes" default=""/>
    <element name="add.javac.elements" optional="true"/>

    <sequential>
        <mkdir dir="${src.dir}"/>
        <mkdir dir="${classes.dir}"/>
        <mkdir dir="${app.lib.dir}"/>

        <javac destdir="${classes.dir}" sourcepath=""
            source="${compile.source}" target="${compile.target}" debug="${compile.debug}" failonerror="@failonerror"
        >
            <src location="${src.dir}"/>
            <include name="**/*.java"/>
            <exclude name="@{src.javac.excludes}" />
            <classpath>
                <fileset dir="${app.lib.dir}" includes="*.jar"/>
                <fileset dir="${icefaces.lib.dir}" >
                  <patternset refid="common.icefaces.lib.jars.to.include"/>
                  <patternset refid="additional.icefaces.lib.jars.to.include"/>
                  <patternset refid="additional.compile.lib.jars"/>
                  <patternset refid="jsf.compile.jars" />
                  <patternset refid="portlet.jar"/>
                </fileset>
            </classpath>
            <add.javac.elements/>
        </javac>

        <copy todir="${classes.dir}" preservelastmodified="true">
            <fileset dir="${src.dir}" excludes="@{src.copy.excludes}"/>
        </copy>
    </sequential>
</macrodef>

<macrodef name="build.war">
    <attribute name="war.file.name" default="${ant.project.name}.war"/>
    <attribute name="web.xml" default="${web.inf.dir}/web.xml"/>
    <element name="add.filesets" optional="true"/>

    <sequential>
        <mkdir dir="${dist.dir}"/>

        <copy todir="${web.inf.dir}" preservelastmodified="true">
            <fileset dir="${build.common.basedir}" includes="web.xml">
                <present present="srconly" targetdir="${web.inf.dir}"/>
            </fileset>
        </copy>

        <copy file="@{web.xml}" tofile="${web.inf.dir}/web.xml" preservelastmodified="true" overwrite="true"/>

        <copy todir="${app.lib.dir}" preservelastmodified="true">
            <fileset dir="${icefaces.lib.dir}">
                <patternset refid="common.icefaces.lib.jars.to.include"/>
                <patternset refid="additional.icefaces.lib.jars.to.include"/>
            </fileset>
            <fileset dir="${icefaces.lib.dir}">
                <patternset refid="jsf.deploy.jars" />
            </fileset>
        </copy>

        <war basedir="${web.content.dir}" destfile="${dist.dir}/@{war.file.name}" duplicate="fail"
             webxml="${web.inf.dir}/web.xml" excludes="WEB-INF/web.xml">
            <add.filesets/>
        </war>
    </sequential>
</macrodef>

<macrodef name="build.portlet.war">
    <attribute name="war.file.name" default="${ant.project.name}.war"/>
    <attribute name="web.xml" default="${web.inf.dir}/web.xml"/>
    <element name="add.filesets" optional="true"/>

    <sequential>
        <mkdir dir="${dist.dir}"/>

        <copy todir="${web.inf.dir}" preservelastmodified="true">
            <fileset dir="${build.common.basedir}" includes="web.xml">
                <present present="srconly" targetdir="${web.inf.dir}"/>
            </fileset>
        </copy>
        

        <copy todir="${portlet.web.content.dir}/portlet">
        	<fileset dir="${portlet.web.dir}">
			<include name="*.jspx"/>
       		</fileset>
       	</copy>
        <copy todir="${portlet.web.content.dir}">
       		
        	<fileset dir="${web.content.dir}"/>
        </copy>
        <copy todir="${portlet.web.inf.dir}">
       		<fileset dir="${portlet.conf.dir}">
			<include name="${portlet.xml}"/>
		</fileset>
		<fileset dir="${portlet.liferay.dir}">
			<patternset refid="liferay.xmls"/>
		</fileset>
        </copy>

        <copy file="@{web.xml}" tofile="${portlet.web.inf.dir}/web.xml" preservelastmodified="true" overwrite="true"/>

        <copy todir="${portlet.app.lib.dir}" preservelastmodified="true">
            <fileset dir="${icefaces.lib.dir}">
                <patternset refid="common.icefaces.lib.jars.to.include"/>
                <patternset refid="additional.icefaces.lib.jars.to.include"/>
            </fileset>
            <fileset dir="${icefaces.lib.dir}">
                <patternset refid="jsf.deploy.jars" />
            </fileset>
        </copy>

        <war basedir="${portlet.web.content.dir}" destfile="${dist.dir}/@{war.file.name}" duplicate="fail"
             webxml="${portlet.web.inf.dir}/web.xml" excludes="WEB-INF/web.xml">
            <add.filesets/>
        </war>
        
    </sequential>
</macrodef>

<target name="clean" description="">
    <clean/>
</target>

<target name="compile" description="">
    <compile/>
</target>

<target name="build.war" description="" depends="compile">
    <build.war/>
</target>

<target name="build.portlet.war" description="" depends="compile">
	<property name="portlet" value="true"/>
	<build.portlet.war/>
</target>

<target name="build.ear" description="" depends="build.war">
    <copy todir="conf" preservelastmodified="true">
        <fileset dir="${build.common.basedir}" includes="application.xml">
            <present present="srconly" targetdir="conf"/>
        </fileset>
        <filterset>
            <filter token="project_name" value="${ant.project.name}"/>
        </filterset>
    </copy>

    <ear destfile="${dist.dir}/${ant.project.name}.ear" appxml="conf/application.xml">
        <fileset dir="${dist.dir}" includes="*.war"/>
    </ear>
</target>

<target name="help" description="help information for building different versions of this application">
	<echo level="info">
	-Djsf12=""                  to build the web application archive (war file) for jsf1.2 version
	-Djsf12="" -Dserverjsf=""   to build the web application archive (war file) for Jboss 4.2, GlassfishV2 and SUN App ServerPE9
	-Dmyfaces=""                to build the web application archive (war file) for Facelets
	</echo>
</target>

<!-- server specified -->
<target name="tomcat5.5" depends="build.war" description="Tomcat 5.5"/>
<target name="sap04" depends="build.war" description="SAP NetWeaver 04"/>
<target name="jboss4.0" depends="build.war" description="JBoss 4.0.5"/>
<target name="weblogic8.1" depends="build.war" description="Weblogic 8.1"/>
<target name="weblogic9.2" depends="build.war" description="Weblogic 9.2"/>
<target name="websphere6.0" depends="build.war" description="IBM Websphere 6.0.2"/>
<target name="websphere6.1" depends="build.war" description="IBM Websphere 6.1"/>
<!--
<target name="sap04">
	<antcall target="build.war"/>
</target>
<target name="jboss4.0.5">
	<antcall target="build.war"/>
</target>
<target name="weblogic8.1">
	<antcall target="build.war"/>
</target>
<target name="weblogic9.2">
	<antcall target="build.war"/>
</target>
<target name="websphere6.0">
	<antcall target="build.war"/>
</target>
<target name="websphere6.1">
	<antcall target="build.war"/>
</target>
-->

<target name="build.portlet.jboss4.2.war" description="portlet version for Jboss4.2" depends="compile">
	<antcall target="build.portlet.war">
		<param name="jsf12" value=""/>
		<param name="serverjsf" value=""/>
	</antcall>
</target>

<target name="build.portlet.liferay.war" description="portlet version for liferay tomcat5"  depends="compile">
	<property name="portlet" value="true"/>
	<antcall target="build.portlet.war">
		<param name="liferay" value=""/>
	</antcall>
</target>

<target name="tomcat6.0" description="Tomcat 6.0">
	<antcall target="build.war">
		<param name="jsf12" value=""/>
	</antcall>
</target>
<target name="jetty6.1" description="Jetty 6.1">
	<antcall target="build.war">
		<param name="serverel" value=""/>
	</antcall>
</target>
<target name="jboss4.2" description="JBoss 4.2">
	<antcall target="build.war">
		<param name="jsf12" value=""/>
		<param name="serverjsf" value=""/>
	</antcall>
</target>
<target name="glassfishv2" description="SUN Glassfish V2">
	<antcall target="build.war">
		<param name="jsf12" value=""/>
		<param name="serverjsf" value=""/>
	</antcall>
</target>
<target name="pe9" description="SUN Application Server PE9">
	<antcall target="build.war">
		<param name="jsf12" value=""/>
		<param name="serverjsf" value=""/>
	</antcall>
</target>



</project>
